<!DOCTYPE html>

<html lang="fr">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0">
<title>TEST â€” Action ou VÃ©ritÃ© ğŸ”¥</title>
<link rel="preconnect" href="https://fonts.googleapis.com">
<link href="https://fonts.googleapis.com/css2?family=Bebas+Neue&family=DM+Sans:wght@400;500;700&family=Space+Mono:wght@400;700&display=swap" rel="stylesheet">
<style>
/* ===================================================
   RESET & ROOT
=================================================== */
*, *::before, *::after { margin: 0; padding: 0; box-sizing: border-box; }

:root {
â€“bg:       #06060e;
â€“bg2:      #0e0e1c;
â€“bg3:      #161628;
â€“border:   rgba(255,255,255,0.07);
â€“pink:     #ff2d78;
â€“purple:   #8b5cf6;
â€“cyan:     #06d6e0;
â€“gold:     #fbbf24;
â€“green:    #10b981;
â€“red:      #ef4444;
â€“orange:   #f97316;
â€“text:     #f1f0ff;
â€“muted:    #6b7280;
â€“r:        18px;
â€“r-sm:     12px;
}

html, body {
min-height: 100vh;
background: var(â€“bg);
color: var(â€“text);
font-family: â€˜DM Sansâ€™, sans-serif;
overflow-x: hidden;
}

/* ===================================================
ANIMATED BACKGROUND
=================================================== */
#bg-canvas {
position: fixed;
inset: 0;
z-index: 0;
pointer-events: none;
}

.app {
position: relative;
z-index: 1;
min-height: 100vh;
display: flex;
flex-direction: column;
align-items: center;
justify-content: center;
padding: 16px;
}

/* ===================================================
SCREENS
=================================================== */
.screen { display: none; width: 100%; max-width: 440px; }
.screen.show { display: flex; flex-direction: column; align-items: center; }

/* ===================================================
TYPOGRAPHY
=================================================== */
.title-huge {
font-family: â€˜Bebas Neueâ€™, sans-serif;
font-size: clamp(52px, 14vw, 88px);
line-height: 0.88;
letter-spacing: 2px;
background: linear-gradient(135deg, var(â€“pink) 0%, var(â€“purple) 55%, var(â€“cyan) 100%);
-webkit-background-clip: text;
-webkit-text-fill-color: transparent;
background-clip: text;
text-align: center;
}

.title-med {
font-family: â€˜Bebas Neueâ€™, sans-serif;
font-size: 28px;
letter-spacing: 2px;
}

.subtitle {
font-size: 13px;
color: var(â€“muted);
text-align: center;
letter-spacing: 1px;
}

.label {
font-size: 10px;
letter-spacing: 3px;
text-transform: uppercase;
color: var(â€“muted);
margin-bottom: 6px;
display: block;
}

/* ===================================================
CARDS & PANELS
=================================================== */
.card {
background: var(â€“bg2);
border: 1px solid var(â€“border);
border-radius: var(â€“r);
padding: 28px 24px;
width: 100%;
position: relative;
overflow: hidden;
}

.card::before {
content: â€˜â€™;
position: absolute;
top: 0; left: 0; right: 0;
height: 1px;
background: linear-gradient(90deg, transparent, rgba(255,255,255,0.12), transparent);
}

.card-glow-pink { box-shadow: 0 0 60px rgba(255,45,120,0.08); }
.card-glow-purple { box-shadow: 0 0 60px rgba(139,92,246,0.1); }

/* ===================================================
BUTTONS
=================================================== */
.btn {
display: flex; align-items: center; justify-content: center; gap: 8px;
padding: 16px 24px;
border-radius: var(â€“r-sm);
border: none;
font-family: â€˜DM Sansâ€™, sans-serif;
font-weight: 700;
font-size: 15px;
cursor: pointer;
transition: transform 0.15s, opacity 0.15s, box-shadow 0.2s;
width: 100%;
position: relative;
overflow: hidden;
letter-spacing: 0.3px;
}
.btn::after {
content: â€˜â€™;
position: absolute;
inset: 0;
background: rgba(255,255,255,0);
transition: background 0.15s;
}
.btn:hover::after { background: rgba(255,255,255,0.06); }
.btn:active { transform: scale(0.97); }
.btn:disabled { opacity: 0.45; cursor: not-allowed; }

.btn-primary {
background: linear-gradient(135deg, var(â€“pink), var(â€“purple));
color: #fff;
box-shadow: 0 4px 24px rgba(255,45,120,0.35);
}
.btn-primary:hover { box-shadow: 0 6px 32px rgba(255,45,120,0.5); }

.btn-secondary {
background: linear-gradient(135deg, var(â€“purple), var(â€“cyan));
color: #fff;
box-shadow: 0 4px 24px rgba(139,92,246,0.3);
}

.btn-outline {
background: transparent;
border: 1.5px solid var(â€“border);
color: var(â€“text);
}
.btn-outline:hover { border-color: rgba(255,255,255,0.2); }

.btn-ghost {
background: var(â€“bg3);
color: var(â€“muted);
border: 1px solid var(â€“border);
}
.btn-ghost:hover { color: var(â€“text); }

.btn-sm { padding: 10px 18px; font-size: 13px; border-radius: 10px; }

.btn-action {
background: linear-gradient(135deg, rgba(249,115,22,0.15), rgba(249,115,22,0.05));
border: 1.5px solid rgba(249,115,22,0.4);
color: var(â€“orange);
font-size: 17px;
padding: 22px 16px;
border-radius: 16px;
flex-direction: column;
gap: 4px;
}
.btn-action:hover { background: rgba(249,115,22,0.15); box-shadow: 0 8px 32px rgba(249,115,22,0.2); transform: translateY(-2px); }

.btn-verite {
background: linear-gradient(135deg, rgba(6,214,224,0.15), rgba(6,214,224,0.05));
border: 1.5px solid rgba(6,214,224,0.4);
color: var(â€“cyan);
font-size: 17px;
padding: 22px 16px;
border-radius: 16px;
flex-direction: column;
gap: 4px;
}
.btn-verite:hover { background: rgba(6,214,224,0.15); box-shadow: 0 8px 32px rgba(6,214,224,0.2); transform: translateY(-2px); }

/* ===================================================
INPUTS
=================================================== */
.input {
width: 100%;
padding: 14px 16px;
background: var(â€“bg3);
border: 1px solid var(â€“border);
border-radius: var(â€“r-sm);
color: var(â€“text);
font-family: â€˜DM Sansâ€™, sans-serif;
font-size: 15px;
outline: none;
transition: border-color 0.2s, box-shadow 0.2s;
}
.input:focus {
border-color: var(â€“pink);
box-shadow: 0 0 0 3px rgba(255,45,120,0.12);
}
.input::placeholder { color: var(â€“muted); }

.input-code {
text-align: center;
font-family: â€˜Space Monoâ€™, monospace;
font-size: 28px;
font-weight: 700;
letter-spacing: 10px;
}

.textarea {
width: 100%;
min-height: 90px;
padding: 14px 16px;
background: var(â€“bg3);
border: 1px solid var(â€“border);
border-radius: var(â€“r-sm);
color: var(â€“text);
font-family: â€˜DM Sansâ€™, sans-serif;
font-size: 15px;
outline: none;
resize: none;
transition: border-color 0.2s, box-shadow 0.2s;
line-height: 1.5;
}
.textarea:focus {
border-color: var(â€“purple);
box-shadow: 0 0 0 3px rgba(139,92,246,0.12);
}
.textarea::placeholder { color: var(â€“muted); }

.select {
width: 100%;
padding: 14px 16px;
background: var(â€“bg3);
border: 1px solid var(â€“border);
border-radius: var(â€“r-sm);
color: var(â€“text);
font-family: â€˜DM Sansâ€™, sans-serif;
font-size: 15px;
outline: none;
cursor: pointer;
appearance: none;
-webkit-appearance: none;
background-image: url(â€œdata:image/svg+xml,%3Csvg xmlns=â€˜http://www.w3.org/2000/svgâ€™ width=â€˜12â€™ height=â€˜8â€™ viewBox=â€˜0 0 12 8â€™%3E%3Cpath d=â€˜M1 1l5 5 5-5â€™ stroke=â€™%236b7280â€™ stroke-width=â€˜1.5â€™ fill=â€˜noneâ€™ stroke-linecap=â€˜roundâ€™/%3E%3C/svg%3Eâ€);
background-repeat: no-repeat;
background-position: right 16px center;
}
.select option { background: var(â€“bg2); }

/* ===================================================
CATEGORY GRID
=================================================== */
.cat-grid {
display: grid;
grid-template-columns: 1fr 1fr;
gap: 10px;
width: 100%;
}

.cat-tile {
padding: 16px 12px;
border-radius: 14px;
border: 1.5px solid var(â€“border);
background: var(â€“bg3);
cursor: pointer;
text-align: center;
transition: all 0.18s;
user-select: none;
position: relative;
overflow: hidden;
}
.cat-tile:hover { border-color: rgba(255,255,255,0.15); transform: translateY(-1px); }

.cat-tile.on { border-color: currentColor; }
.cat-tile.on::after {
content: â€˜âœ“â€™;
position: absolute;
top: 7px; right: 9px;
font-size: 12px;
font-weight: bold;
}

.cat-tile .big { font-size: 26px; display: block; margin-bottom: 4px; }
.cat-tile .name { font-size: 12px; font-weight: 700; display: block; }
.cat-tile .cnt { font-size: 10px; font-family: â€˜Space Monoâ€™; opacity: 0.5; }

.cat-classique { color: #93c5fd; }
.cat-coquin    { color: #f9a8d4; }
.cat-couple    { color: #c4b5fd; }
.cat-hot       { color: var(â€“orange); }

/* ===================================================
CODE DISPLAY
=================================================== */
.code-box {
background: var(â€“bg3);
border: 1px solid var(â€“border);
border-radius: 16px;
padding: 20px 24px;
text-align: center;
position: relative;
overflow: hidden;
}
.code-box::before {
content: â€˜â€™;
position: absolute;
inset: 0;
background: linear-gradient(135deg, rgba(255,45,120,0.04), transparent 60%);
}
.code-num {
font-family: â€˜Bebas Neueâ€™, sans-serif;
font-size: 58px;
letter-spacing: 14px;
background: linear-gradient(135deg, var(â€“cyan), var(â€“pink));
-webkit-background-clip: text;
-webkit-text-fill-color: transparent;
background-clip: text;
display: block;
line-height: 1;
}
.code-copy-hint {
font-size: 11px;
color: var(â€“muted);
cursor: pointer;
margin-top: 6px;
transition: color 0.2s;
}
.code-copy-hint:hover { color: var(â€“cyan); }

/* ===================================================
PLAYER LIST (LOBBY)
=================================================== */
.player-list { display: flex; flex-direction: column; gap: 8px; width: 100%; }

.player-row {
display: flex;
align-items: center;
gap: 12px;
padding: 12px 16px;
background: var(â€“bg3);
border-radius: 12px;
border: 1px solid var(â€“border);
transition: border-color 0.3s;
animation: slideIn 0.3s ease-out;
}
.player-row.is-me { border-color: rgba(255,45,120,0.3); }

.p-avatar {
width: 40px; height: 40px;
border-radius: 50%;
display: flex; align-items: center; justify-content: center;
font-size: 19px;
flex-shrink: 0;
}
.p-name { font-weight: 700; font-size: 14px; flex: 1; }
.p-badge {
font-size: 10px;
padding: 3px 9px;
border-radius: 20px;
font-family: â€˜Space Monoâ€™;
}
.badge-host { background: rgba(251,191,36,0.15); color: var(â€“gold); }
.badge-ready { background: rgba(16,185,129,0.15); color: var(â€“green); }
.badge-me { background: rgba(255,45,120,0.15); color: var(â€“pink); }

.slot-empty {
display: flex;
align-items: center;
gap: 10px;
padding: 12px 16px;
border: 1px dashed rgba(255,255,255,0.07);
border-radius: 12px;
color: var(â€“muted);
font-size: 13px;
}

/* ===================================================
GAME HEADER
=================================================== */
.game-topbar {
display: flex;
justify-content: space-between;
align-items: center;
width: 100%;
max-width: 520px;
margin-bottom: 16px;
padding: 0 4px;
}

.turn-info { text-align: center; }
.turn-label { font-size: 10px; letter-spacing: 2px; text-transform: uppercase; color: var(â€“muted); }
.turn-name {
font-family: â€˜Bebas Neueâ€™, sans-serif;
font-size: 22px;
letter-spacing: 1px;
background: linear-gradient(135deg, var(â€“pink), var(â€“purple));
-webkit-background-clip: text;
-webkit-text-fill-color: transparent;
background-clip: text;
}

.round-pill {
font-family: â€˜Space Monoâ€™, monospace;
font-size: 11px;
color: var(â€“muted);
background: var(â€“bg2);
border: 1px solid var(â€“border);
border-radius: 20px;
padding: 6px 12px;
}

/* Progress */
.progress-wrap { width: 100%; max-width: 520px; margin-bottom: 20px; }
.progress-track {
height: 3px;
background: rgba(255,255,255,0.05);
border-radius: 4px;
overflow: hidden;
}
.progress-bar {
height: 100%;
background: linear-gradient(90deg, var(â€“pink), var(â€“purple), var(â€“cyan));
border-radius: 4px;
transition: width 0.6s ease;
}

/* ===================================================
QUESTION CARD
=================================================== */
.q-card {
background: var(â€“bg2);
border: 1px solid var(â€“border);
border-radius: 22px;
padding: 28px 24px;
width: 100%;
max-width: 520px;
position: relative;
overflow: hidden;
animation: cardPop 0.45s cubic-bezier(0.34,1.56,0.64,1);
}
.q-card::before {
content: â€˜â€™;
position: absolute;
top: 0; left: 0; right: 0;
height: 1px;
background: linear-gradient(90deg, transparent, rgba(255,255,255,0.1), transparent);
}

.q-card.type-action { border-top: 3px solid var(â€“orange); }
.q-card.type-verite { border-top: 3px solid var(â€“cyan); }
.q-card.cat-hot { box-shadow: 0 0 60px rgba(255,45,120,0.12); }

.q-tag {
display: inline-flex;
align-items: center;
gap: 5px;
padding: 5px 12px;
border-radius: 20px;
font-size: 11px;
font-weight: 700;
letter-spacing: 1px;
text-transform: uppercase;
margin-bottom: 18px;
}
.tag-action { background: rgba(249,115,22,0.12); color: var(â€“orange); border: 1px solid rgba(249,115,22,0.25); }
.tag-verite { background: rgba(6,214,224,0.12); color: var(â€“cyan); border: 1px solid rgba(6,214,224,0.25); }

.q-cat-chip {
float: right;
font-size: 9px;
letter-spacing: 1.5px;
text-transform: uppercase;
color: var(â€“muted);
background: var(â€“bg3);
border: 1px solid var(â€“border);
border-radius: 6px;
padding: 3px 8px;
}

.q-text {
font-family: â€˜DM Sansâ€™, sans-serif;
font-weight: 700;
font-size: clamp(17px, 4.5vw, 22px);
line-height: 1.45;
margin-bottom: 24px;
min-height: 60px;
clear: both;
}

/* choose grid */
.choose-grid {
display: grid;
grid-template-columns: 1fr 1fr;
gap: 12px;
margin-top: 4px;
}

.choice-icon { font-size: 30px; }
.choice-label { font-family: â€˜Bebas Neueâ€™; font-size: 20px; letter-spacing: 1px; }
.choice-sub { font-size: 10px; font-family: â€˜Space Monoâ€™; opacity: 0.6; font-weight: 400; }

/* Waiting dots */
.dots { display: flex; gap: 6px; justify-content: center; margin: 12px 0; }
.dot {
width: 9px; height: 9px;
border-radius: 50%;
animation: dotBounce 1.2s ease-in-out infinite;
}
.dot:nth-child(1) { background: var(â€“pink); }
.dot:nth-child(2) { background: var(â€“purple); animation-delay: 0.15s; }
.dot:nth-child(3) { background: var(â€“cyan); animation-delay: 0.3s; }

/* ===================================================
REVEAL CARDS
=================================================== */
.reveal-wrap { width: 100%; max-width: 520px; }

.reveal-header {
text-align: center;
margin-bottom: 18px;
}
.reveal-title {
font-family: â€˜Bebas Neueâ€™, sans-serif;
font-size: 32px;
letter-spacing: 2px;
color: var(â€“gold);
}

.answer-card {
background: var(â€“bg2);
border: 1px solid var(â€“border);
border-radius: 14px;
padding: 16px 18px;
margin-bottom: 10px;
border-left: 3px solid var(â€“pink);
animation: slideIn 0.3s ease-out;
}
.answer-who {
font-size: 12px;
font-weight: 700;
margin-bottom: 6px;
display: flex;
align-items: center;
gap: 6px;
}
.answer-text {
font-size: 15px;
line-height: 1.5;
color: var(â€“text);
}
.answer-empty { color: var(â€“muted); font-style: italic; font-size: 13px; }

/* ===================================================
END SCREEN
=================================================== */
.trophy { font-size: 72px; text-align: center; margin-bottom: 8px; }
.podium { display: flex; flex-direction: column; gap: 8px; width: 100%; }
.podium-row {
display: flex;
align-items: center;
gap: 12px;
padding: 14px 18px;
background: var(â€“bg2);
border-radius: 14px;
border: 1px solid var(â€“border);
}
.podium-rank { font-family: â€˜Bebas Neueâ€™; font-size: 26px; width: 30px; text-align: center; }
.podium-name { font-weight: 700; flex: 1; }
.podium-info { font-size: 11px; color: var(â€“muted); font-family: â€˜Space Monoâ€™; }

/* ===================================================
TOAST
=================================================== */
#toast {
position: fixed;
bottom: 24px;
left: 50%;
transform: translateX(-50%) translateY(100px);
background: var(â€“bg2);
border: 1px solid rgba(255,255,255,0.1);
border-radius: 12px;
padding: 13px 22px;
font-weight: 600;
font-size: 14px;
z-index: 9999;
transition: transform 0.35s cubic-bezier(0.34,1.56,0.64,1);
white-space: nowrap;
max-width: 90vw;
text-align: center;
pointer-events: none;
}
#toast.up { transform: translateX(-50%) translateY(0); }
#toast.ok { border-color: var(â€“green); }
#toast.err { border-color: var(â€“red); }
#toast.inf { border-color: var(â€“purple); }

/* ===================================================
LOADING SCREEN
=================================================== */
#screen-loading {
display: flex;
flex-direction: column;
align-items: center;
gap: 16px;
}
.spinner-ring {
width: 44px; height: 44px;
border: 3px solid rgba(255,255,255,0.06);
border-top-color: var(â€“pink);
border-radius: 50%;
animation: spin 0.8s linear infinite;
}

/* ===================================================
UTILS
=================================================== */
.row { display: flex; gap: 10px; align-items: center; }
.col { display: flex; flex-direction: column; gap: 12px; width: 100%; }
.center { text-align: center; }
.mt4 { margin-top: 4px; }
.mt8 { margin-top: 8px; }
.mt12 { margin-top: 12px; }
.mt16 { margin-top: 16px; }
.mt20 { margin-top: 20px; }
.mt24 { margin-top: 24px; }
.mb8 { margin-bottom: 8px; }
.mb12 { margin-bottom: 12px; }
.mb16 { margin-bottom: 16px; }
.mb20 { margin-bottom: 20px; }
.sep { width: 100%; height: 1px; background: var(â€“border); margin: 16px 0; }
.w100 { width: 100%; }
.flex1 { flex: 1; }
.text-pink { color: var(â€“pink); }
.text-cyan { color: var(â€“cyan); }
.text-gold { color: var(â€“gold); }
.text-muted { color: var(â€“muted); }
.text-green { color: var(â€“green); }
.text-sm { font-size: 13px; }
.text-xs { font-size: 11px; }
.bold { font-weight: 700; }
.mono { font-family: â€˜Space Monoâ€™, monospace; }

/* ===================================================
BACK BTN
=================================================== */
.back-btn {
position: fixed;
top: 14px; left: 14px;
z-index: 200;
background: var(â€“bg2);
border: 1px solid var(â€“border);
border-radius: 10px;
padding: 8px 14px;
color: var(â€“muted);
font-size: 13px;
font-weight: 700;
cursor: pointer;
font-family: â€˜DM Sansâ€™, sans-serif;
display: none;
align-items: center;
gap: 4px;
transition: color 0.2s, border-color 0.2s;
}
.back-btn:hover { color: var(â€“text); border-color: rgba(255,255,255,0.15); }
.back-btn.vis { display: flex; }

/* ===================================================
ANIMATIONS
=================================================== */
@keyframes cardPop {
from { opacity: 0; transform: scale(0.88) translateY(12px); }
to   { opacity: 1; transform: scale(1) translateY(0); }
}
@keyframes slideIn {
from { opacity: 0; transform: translateY(10px); }
to   { opacity: 1; transform: translateY(0); }
}
@keyframes dotBounce {
0%,80%,100% { transform: scale(1); opacity: 0.4; }
40%          { transform: scale(1.5); opacity: 1; }
}
@keyframes spin { to { transform: rotate(360deg); } }
@keyframes confetti {
to { transform: translateY(110vh) rotate(720deg); opacity: 0; }
}
@keyframes fadeIn {
from { opacity: 0; } to { opacity: 1; }
}
.fade-in { animation: fadeIn 0.4s ease-out; }

/* error shake */
.shake {
animation: doShake 0.35s ease;
}
@keyframes doShake {
0%,100% { transform: translateX(0); }
20%     { transform: translateX(-8px); }
40%     { transform: translateX(8px); }
60%     { transform: translateX(-5px); }
80%     { transform: translateX(4px); }
}

@media (max-width: 380px) {
.q-text { font-size: 16px; }
.card { padding: 22px 18px; }
}
</style>

</head>
<body>

<!-- Animated background -->

<canvas id="bg-canvas"></canvas>

<!-- Back button -->

<button class="back-btn" id="back-btn" onclick="goBack()">â† Quitter</button>

<!-- Toast -->

<div id="toast"></div>

<div class="app">

  <!-- =================== LOADING =================== -->

  <div id="screen-loading" class="screen show">
    <div class="spinner-ring"></div>
    <div class="text-muted text-sm">Connexion Ã  Firebase...</div>
  </div>

  <!-- =================== HOME =================== -->

  <div id="screen-home" class="screen">
    <div class="mb20" style="animation: cardPop 0.5s ease-out">
      <div style="text-align:center;font-size:11px;letter-spacing:4px;color:var(--pink);margin-bottom:8px;text-transform:uppercase">ğŸ”¥ Le jeu de soirÃ©e</div>
      <div class="title-huge">TEST</div>
      <div style="font-family:'Bebas Neue';font-size:22px;letter-spacing:3px;text-align:center;color:var(--muted);margin-top:4px">Action ou VÃ©ritÃ©</div>
    </div>

```
<div style="display:flex;gap:8px;flex-wrap:wrap;justify-content:center;margin-bottom:28px">
  <span style="padding:4px 12px;border-radius:20px;background:rgba(249,115,22,0.1);color:var(--orange);font-size:11px;border:1px solid rgba(249,115,22,0.2)">ğŸ’ª Action</span>
  <span style="padding:4px 12px;border-radius:20px;background:rgba(6,214,224,0.1);color:var(--cyan);font-size:11px;border:1px solid rgba(6,214,224,0.2)">ğŸ’¬ VÃ©ritÃ©</span>
  <span style="padding:4px 12px;border-radius:20px;background:rgba(255,45,120,0.1);color:var(--pink);font-size:11px;border:1px solid rgba(255,45,120,0.2)">ğŸ”¥ Hot</span>
</div>

<div class="col" style="max-width:380px">
  <button class="btn btn-primary" onclick="showScreen('screen-create')">
    ğŸ¯ CrÃ©er une partie
  </button>
  <button class="btn btn-secondary" onclick="showScreen('screen-join')">
    ğŸšª Rejoindre une partie
  </button>
</div>

<div class="mt20 text-xs text-muted center">Vrai multijoueur en ligne â€¢ 2â€“8 joueurs â€¢ 210+ questions</div>
```

  </div>

  <!-- =================== CREATE =================== -->

  <div id="screen-create" class="screen">
    <div class="card card-glow-pink w100" style="max-width:420px">
      <div class="title-med mb16 text-pink">CrÃ©er une partie ğŸ¯</div>

```
  <div class="col">
    <div>
      <span class="label">Ton prÃ©nom</span>
      <input type="text" class="input" id="c-name" placeholder="Ex: Sophie" maxlength="16" autocomplete="off">
    </div>

    <div>
      <span class="label">Nombre de rounds</span>
      <select class="select" id="c-rounds">
        <option value="10">10 rounds â€” rapide ğŸƒ</option>
        <option value="20" selected>20 rounds â€” normal âš¡</option>
        <option value="30">30 rounds â€” long ğŸª</option>
        <option value="50">50 rounds â€” marathon ğŸŸï¸</option>
      </select>
    </div>

    <div>
      <span class="label">CatÃ©gories</span>
      <div class="cat-grid">
        <div class="cat-tile cat-classique on" data-cat="classique" onclick="toggleCat(this)">
          <span class="big">ğŸ˜‚</span>
          <span class="name">Classique</span>
          <span class="cnt">68 questions</span>
        </div>
        <div class="cat-tile cat-coquin on" data-cat="coquin" onclick="toggleCat(this)">
          <span class="big">ğŸ˜</span>
          <span class="name">Coquin</span>
          <span class="cnt">52 questions</span>
        </div>
        <div class="cat-tile cat-couple" data-cat="couple" onclick="toggleCat(this)">
          <span class="big">ğŸ’‘</span>
          <span class="name">Couple</span>
          <span class="cnt">46 questions</span>
        </div>
        <div class="cat-tile cat-hot" data-cat="hot" onclick="toggleCat(this)">
          <span class="big">ğŸ”¥</span>
          <span class="name">Hot 18+</span>
          <span class="cnt">44 questions</span>
        </div>
      </div>
    </div>

    <button class="btn btn-primary" onclick="createGame()">CrÃ©er la partie âœ¨</button>
    <button class="btn btn-ghost btn-sm" onclick="showScreen('screen-home')">â† Retour</button>
  </div>
</div>
```

  </div>

  <!-- =================== JOIN =================== -->

  <div id="screen-join" class="screen">
    <div class="card w100" style="max-width:380px">
      <div class="title-med mb16" style="color:var(--cyan)">Rejoindre ğŸšª</div>
      <div class="col">
        <div>
          <span class="label">Ton prÃ©nom</span>
          <input type="text" class="input" id="j-name" placeholder="Ex: Alex" maxlength="16" autocomplete="off">
        </div>
        <div>
          <span class="label">Code de la partie</span>
          <input type="text" class="input input-code" id="j-code" placeholder="XXXX" maxlength="4"
            oninput="this.value=this.value.toUpperCase().replace(/[^A-Z0-9]/g,'')"
            onkeydown="if(event.key==='Enter')joinGame()">
        </div>
        <button class="btn btn-secondary" onclick="joinGame()">Rejoindre ğŸš€</button>
        <button class="btn btn-ghost btn-sm" onclick="showScreen('screen-home')">â† Retour</button>
      </div>
    </div>
  </div>

  <!-- =================== LOBBY =================== -->

  <div id="screen-lobby" class="screen">
    <div class="card w100 mb12" style="max-width:440px">
      <div class="center mb12">
        <div class="title-med">Salle d'attente ğŸ®</div>
        <div class="text-sm text-muted mt4">Partage le code Ã  tes amis</div>
      </div>
      <div class="code-box mb16">
        <span class="code-num" id="l-code">----</span>
        <div class="code-copy-hint" onclick="copyCode()">ğŸ“‹ Appuyer pour copier</div>
      </div>
      <div class="player-list" id="l-players"></div>
      <div class="sep"></div>
      <div id="l-settings" class="text-xs text-muted center mb12" style="line-height:1.8"></div>
      <div id="l-status" class="center text-sm text-muted mb12"></div>
      <button class="btn btn-primary w100" id="l-start" onclick="startGame()" style="display:none">ğŸš€ Lancer la partie!</button>
      <div id="l-hint" class="center text-xs text-muted mt8" style="display:none"></div>
    </div>
  </div>

  <!-- =================== GAME =================== -->

  <div id="screen-game" class="screen" style="align-items:center">
    <!-- Topbar -->
    <div class="game-topbar">
      <div class="turn-info">
        <div class="turn-label">Au tour de</div>
        <div class="turn-name" id="g-turn-name">â€”</div>
      </div>
      <div id="g-round" class="round-pill">Round 1/20</div>
    </div>

```
<!-- Progress -->
<div class="progress-wrap">
  <div class="progress-track">
    <div class="progress-bar" id="g-progress" style="width:0%"></div>
  </div>
</div>

<!-- PHASE: CHOOSING (current player picks Action/VÃ©ritÃ©) -->
<div id="phase-choose" class="q-card" style="display:none;max-width:520px">
  <div class="center" style="padding: 8px 0 20px">
    <div style="font-size:44px;margin-bottom:10px">ğŸ²</div>
    <div id="choose-who-text" style="font-family:'Bebas Neue';font-size:22px;letter-spacing:1px;color:var(--pink)">C'EST TON TOUR!</div>
    <div class="text-sm text-muted mt4 mb20">Choisis ta destinÃ©e...</div>
    <div class="choose-grid" id="choose-btns">
      <button class="btn btn-action" onclick="pickType('action')">
        <span class="choice-icon">ğŸ’ª</span>
        <span class="choice-label">ACTION</span>
        <span class="choice-sub">Ose le faire</span>
      </button>
      <button class="btn btn-verite" onclick="pickType('verite')">
        <span class="choice-icon">ğŸ’¬</span>
        <span class="choice-label">VÃ‰RITÃ‰</span>
        <span class="choice-sub">Dis tout</span>
      </button>
    </div>
    <div id="choose-waiting" style="display:none">
      <div class="text-sm text-muted">En attente du choix...</div>
      <div class="dots mt8"><div class="dot"></div><div class="dot"></div><div class="dot"></div></div>
    </div>
  </div>
</div>

<!-- PHASE: ANSWERING -->
<div id="phase-answer" class="q-card" style="display:none;max-width:520px">
  <div class="q-cat-chip" id="a-cat">â€”</div>
  <div class="q-tag" id="a-type-tag">â€”</div>
  <div class="q-text" id="a-question">â€”</div>

  <!-- My turn to answer -->
  <div id="a-my-turn">
    <textarea class="textarea" id="a-input" placeholder="Tape ta rÃ©ponse ici... (ou dÃ©cris ce que tu vas faire)"></textarea>
    <button class="btn btn-primary mt8" onclick="submitAnswer()">Envoyer âœ…</button>
  </div>

  <!-- Waiting for others -->
  <div id="a-wait-others" style="display:none">
    <div class="text-sm text-muted center" id="a-wait-text">En attente des autres...</div>
    <div class="dots mt8"><div class="dot"></div><div class="dot"></div><div class="dot"></div></div>
  </div>
</div>

<!-- PHASE: REVEAL -->
<div id="phase-reveal" class="reveal-wrap" style="display:none">
  <div class="reveal-header">
    <div style="font-size:36px">ğŸ“–</div>
    <div class="reveal-title">RÃ©vÃ©lation!</div>
    <div id="r-question-recap" class="text-sm text-muted mt4 center" style="font-style:italic;padding:0 8px"></div>
  </div>
  <div id="r-answers"></div>
  <button class="btn btn-primary mt16 w100" id="r-next" onclick="nextRound()" style="display:none">Prochaine question â†’</button>
  <div class="center text-xs text-muted mt8" id="r-wait-next" style="display:none">L'hÃ´te passe Ã  la suite...</div>
</div>
```

  </div>

  <!-- =================== END =================== -->

  <div id="screen-end" class="screen">
    <div class="trophy">ğŸ†</div>
    <div class="title-huge mb4" style="font-size:56px">GG!</div>
    <div class="text-muted center mb20" id="e-subtitle">Partie terminÃ©e!</div>
    <div class="podium w100 mb24" id="e-podium"></div>
    <div class="row" style="gap:10px;flex-wrap:wrap;justify-content:center">
      <button class="btn btn-primary" style="width:auto;padding:14px 28px" onclick="playAgain()">ğŸ”„ Rejouer</button>
      <button class="btn btn-ghost" style="width:auto;padding:14px 28px" onclick="goHome()">ğŸ  Accueil</button>
    </div>
  </div>

</div><!-- /app -->

<!-- ===================================================
  FIREBASE SDK (v9 compat)
=================================================== -->

<script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-app-compat.js"></script>

<script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-database-compat.js"></script>

<script>
// =====================================================
// ğŸ”¥ FIREBASE CONFIG  (ta config depuis la photo)
// =====================================================
const firebaseConfig = {
  apiKey: "AIzaSyAWW-rnF1dqdCc5kCuI-d9dTSMrBJCrSb0",
  authDomain: "test-a5848.firebaseapp.com",
  databaseURL: "https://test-a5848-default-rtdb.europe-west1.firebasedatabase.app",
  projectId: "test-a5848",
  storageBucket: "test-a5848.firebasestorage.app",
  messagingSenderId: "704331097703",
  appId: "1:704331097703:web:664a8e24613d38ed2316c2",
  measurementId: "G-H26CH0RF19"
};

firebase.initializeApp(firebaseConfig);
const db = firebase.database();

// =====================================================
// ğŸ—„ï¸ QUESTIONS  (210+ questions)
// =====================================================
const Q = {
  classique: {
    action: [
      "Fais 10 pompes devant tout le monde maintenant.",
      "Imite la personne de ton choix pendant 1 minute. Les autres devinent qui.",
      "Chante le refrain d'une chanson Ã  tue-tÃªte.",
      "Envoie un message bizarre au dernier contact de tes SMS.",
      "Fais une danse ridicule pendant 30 secondes sans s'arrÃªter.",
      "Mange une cuillÃ¨re de sauce piquante sans faire de grimace.",
      "Imite un animal pendant 2 min, les autres devinent lequel.",
      "Fais le tour de la piÃ¨ce Ã  4 pattes en aboyant.",
      "Parle avec un accent exagÃ©rÃ© pour les 3 prochains rounds.",
      "Fais semblant d'Ãªtre un robot pendant 2 minutes.",
      "Bois un verre d'eau sans utiliser tes mains.",
      "Reste sur une jambe pendant toute la durÃ©e du prochain round.",
      "Appelle un parent et dis-lui que tu es amoureux(se) d'un inconnu.",
      "Fais une planche le plus longtemps possible.",
      "Poste une photo embarrassante sur tes stories pendant 5 min.",
      "Chante 'Joyeux Anniversaire' Ã  voix haute Ã  quelqu'un par message vocal.",
      "Parle uniquement en chuchotant pendant 5 minutes.",
      "Fais une roue ou essaie pendant 30 secondes.",
      "Dis un compliment sincÃ¨re Ã  chaque joueur, mÃªme le plus difficile.",
      "LÃ¨che ton coude pendant 10 secondes.",
    ],
    verite: [
      "Quelle est la chose la plus stupide que tu aies jamais faite ?",
      "Quel est le mensonge que tu rÃ©pÃ¨tes le plus souvent dans ta vie ?",
      "Quelle est ta pire peur secrÃ¨te que tu n'avoues jamais ?",
      "Qui dans cette partie appellerais-tu en premier en cas de vrai pÃ©pin ?",
      "Quel est le truc le plus nul et inutile que tu aies achetÃ© ?",
      "Quelle mauvaise habitude as-tu mais ne reconnais jamais en public ?",
      "Si tu pouvais effacer une pÃ©riode de ta vie, laquelle choisirais-tu ?",
      "Quelle est la chose la plus bizarre que tu manges en secret ?",
      "Quel est ton pire souvenir de scolaritÃ© ?",
      "Quelle cÃ©lÃ©britÃ© tu dÃ©testes mais tu suis malgrÃ© tout sur les rÃ©seaux ?",
      "Quel mensonge as-tu dit Ã  tes parents et ils y ont totalement cru ?",
      "DÃ©cris ton crush de collÃ¨ge sans donner son nom.",
      "Quelle est la chose la plus creepy que tu aies faite par curiositÃ© ?",
      "Quelle chanson tu Ã©coutes en boucle mais ne l'avoues jamais ?",
      "Quel film honte tu adores mais ne recommandes jamais ?",
      "Quelle est la chose la plus enfantine que tu fasses encore aujourd'hui ?",
      "Quelle est ta recherche Google la plus honteuse cette semaine ?",
      "Quelle est la chose la plus irrationnelle qui te fait peur ?",
      "Si tu pouvais lire les pensÃ©es d'une personne ici, ce serait qui ?",
      "Quel est le pire conseil que tu aies jamais donnÃ© ?",
      "Combien de fois vÃ©rifies-tu vraiment tes rÃ©seaux par jour ?",
      "Quelle est ta superstition secrÃ¨te ?",
      "As-tu dÃ©jÃ  menti sur ton CV ? Sur quoi exactement ?",
      "Quelle est la chose la plus chÃ¨re que tu aies perdue ou cassÃ©e ?",
      "Quelle est la chose dont tu es le plus jaloux chez quelqu'un ici ?",
      "Quel est ton plus grand regret de l'annÃ©e passÃ©e ?",
      "Si tu Ã©tais invisible 24h, que ferais-tu en premier ?",
      "Quel est le pire truc que tu aies fait Ã  un ex ?",
    ],
  },
  coquin: {
    action: [
      "Fais un massage des Ã©paules Ã  la personne de ton choix pendant 1 minute.",
      "Dis Ã  chaque joueur ce qui te plaÃ®t physiquement chez lui/elle.",
      "Fais un catwalk ultra sÃ©ducteur Ã  travers la piÃ¨ce.",
      "Siffle la personne de ton choix comme si elle passait dans la rue.",
      "Pose ta main sur le genou de quelqu'un pendant 30s sans rire.",
      "Ã‰cris un mot sur le dos de quelqu'un avec ton doigt, il doit deviner.",
      "Fais ton regard le plus sÃ©ducteur possible Ã  la personne en face.",
      "Chuchote quelque chose de mystÃ©rieux Ã  l'oreille de la personne de ton choix.",
      "Mime une scÃ¨ne romantique de film sans un seul mot.",
      "Fais semblant de sÃ©duire une chaise pendant 20 secondes.",
      "Lis un passage de roman Ã  l'eau de rose avec ton intonation la plus dramatique.",
      "Fais la liste de tes 3 plus gros crush secrets (sans noms) Ã  voix haute.",
      "DÃ©cris ton type idÃ©al en dÃ©tail physique, les autres devinent si c'est quelqu'un dans la piÃ¨ce.",
      "Donne un surnom flatteur Ã  chaque joueur et justifie-le.",
    ],
    verite: [
      "Quel est ton plus grand fantasme que tu n'as jamais osÃ© avouer ?",
      "Ã€ quelle cÃ©lÃ©britÃ© as-tu dÃ©jÃ  pensÃ© de faÃ§on romantique ?",
      "Quelle est la chose la plus sÃ©duisante qu'on t'ait jamais dite ?",
      "As-tu dÃ©jÃ  embrassÃ© quelqu'un dans une soirÃ©e et regrettÃ© le lendemain ?",
      "Quelle est la premiÃ¨re chose que tu remarques chez quelqu'un qui t'attire ?",
      "As-tu dÃ©jÃ  envoyÃ© un message flirt au mauvais destinataire ?",
      "Quelle est ta meilleure ou pire expÃ©rience de baiser ?",
      "As-tu dÃ©jÃ  eu le bÃ©guin pour un(e) ami(e) de quelqu'un dans cette partie ?",
      "Quelle est la chose la plus audacieuse que tu aies faite pour plaire Ã  quelqu'un ?",
      "As-tu dÃ©jÃ  stalkÃ© l'ex d'un ex sur les rÃ©seaux ?",
      "Quelle est la dÃ©claration la plus cringe qu'on t'ait jamais faite ?",
      "As-tu dÃ©jÃ  embrassÃ© quelqu'un juste parce que tu t'ennuyais ?",
      "Quelle est la chose la plus risquÃ©e que tu aies faite par attirance ?",
      "As-tu dÃ©jÃ  jouÃ© l'indiffÃ©rent(e) alors que tu Ã©tais totalement accro ?",
      "Quel est le lieu le plus original oÃ¹ tu as embrassÃ© quelqu'un ?",
      "As-tu dÃ©jÃ  eu des sentiments pour ton/ta meilleur(e) ami(e) ?",
      "Quelle est la phrase de drague qui a marchÃ© sur toi contre toute attente ?",
      "Dans cette partie, qui inviterais-tu en date si tout le monde Ã©tait cÃ©libataire ?",
      "As-tu dÃ©jÃ  fait semblant d'aimer quelque chose pour impressionner un crush ?",
      "DÃ©cris ton type idÃ©al en 3 qualitÃ©s physiques et 3 qualitÃ©s de personnalitÃ©.",
      "As-tu dÃ©jÃ  Ã©tÃ© jaloux(se) de faÃ§on totalement irrationnelle ? Raconte.",
      "Quel est le plus long temps sans embrasser quelqu'un que tu aies connu ?",
    ],
  },
  couple: {
    action: [
      "Dis Ã  ton/ta partenaire 3 choses que tu adores chez lui/elle devant tout le monde.",
      "Fais un cÃ¢lin Ã  ton/ta partenaire pendant 60 secondes sans bouger.",
      "Raconte votre premiÃ¨re rencontre avec le maximum de dÃ©tails.",
      "Dessine le visage de ton/ta partenaire de mÃ©moire en 30 secondes.",
      "Chante une chanson qui reprÃ©sente votre relation.",
      "Fais une photo couple maintenant, aussi belle que possible.",
      "Danse un slow avec ton/ta partenaire sans musique.",
      "Dis Ã  ton/ta partenaire quel est ton moment prÃ©fÃ©rÃ© que vous avez partagÃ©.",
      "Ã‰cris 'Je t'aime' sur la main de ton/ta partenaire avec ton doigt.",
      "DÃ©cris ton/ta partenaire en 3 superpouvoirs qu'il/elle a.",
    ],
    verite: [
      "Quel est le dÃ©faut de ton/ta partenaire que tu as mis le plus de temps Ã  accepter ?",
      "Quel est le souvenir que tu chÃ©ris le plus dans votre relation ?",
      "Y a-t-il quelque chose que tu n'as jamais osÃ© dire Ã  ton/ta partenaire ?",
      "Quelle est la dispute la plus ridicule que vous ayez jamais eue ?",
      "Qu'est-ce qui t'a fait rÃ©aliser que tu Ã©tais vraiment amoureux(se) ?",
      "Si tu devais dÃ©crire votre relation avec un film, lequel ?",
      "As-tu dÃ©jÃ  doutÃ© de votre relation ? Dans quel contexte ?",
      "Quelle est la chose que ton/ta partenaire fait et que tu n'exprimes pas assez que tu adores ?",
      "Si vous deviez voyager ensemble, quelle serait votre destination de rÃªve ?",
      "Quel est le sacrifice le plus grand que tu aies fait pour ton/ta partenaire ?",
      "Comment imagines-tu votre vie dans 10 ans ensemble ?",
      "Quelle est la chose la plus folle que tu ferais pour cette relation ?",
      "Qu'est-ce que ton/ta partenaire fait qui te fait encore sourire aprÃ¨s tout ce temps ?",
      "As-tu dÃ©jÃ  Ã©tÃ© jaloux(se) sans raison valable ? De qui ?",
      "Si tu pouvais changer une chose dans votre relation, laquelle ?",
      "Quelle est la qualitÃ© de ton/ta partenaire que tu voudrais avoir toi-mÃªme ?",
      "Quel est le moment oÃ¹ tu as Ã©tÃ© le plus fier(fiÃ¨re) de ton/ta partenaire ?",
      "As-tu dÃ©jÃ  eu peur de perdre ton/ta partenaire ? Qu'est-ce qui t'a fait peur ?",
      "Quel est le truc innocent que ton/ta partenaire fait qui te rend dingue (en bien) ?",
      "Si tu devais dÃ©crire ton amour en une seule chanson, laquelle ?",
      "Quel est le cadeau le plus significatif que vous vous soyez jamais offert ?",
      "Comment gÃ¨res-tu les moments oÃ¹ tu n'es pas d'accord avec ton/ta partenaire ?",
      "Quelle est la premiÃ¨re chose que tu as remarquÃ©e chez ton/ta partenaire ?",
    ],
  },
  hot: {
    action: [
      "DÃ©cris en dÃ©tail ta tenue de rÃªve pour une soirÃ©e intime.",
      "Montre les derniers emojis que tu as envoyÃ©s et explique le contexte.",
      "Lis tes 3 derniers messages Ã  voix haute sans les regarder avant.",
      "Fais la liste de tes 3 fantasmes les plus fous Ã  voix haute.",
      "Dis Ã  voix haute ce que tu ferais si vous Ã©tiez seuls ce soir.",
      "Envoie un message trÃ¨s flatteur et suggÃ©rÃ© Ã  ton/ta partenaire maintenant.",
      "DÃ©cris ton expÃ©rience la plus mÃ©morable en 30 secondes.",
      "Dis Ã  chaque joueur ce que tu trouves sensuellement attirant chez lui/elle.",
    ],
    verite: [
      "Quelle est ta position prÃ©fÃ©rÃ©e ? Tu sais de quoi on parle ğŸ˜",
      "OÃ¹ est l'endroit le plus insolite oÃ¹ tu as vÃ©cu une expÃ©rience intime ?",
      "Quelle est ta limite absolue dans une relation intime ?",
      "As-tu dÃ©jÃ  eu un rÃªve Ã©rotique impliquant quelqu'un d'inattendu ?",
      "Combien de partenaires romantiques as-tu eu ? Soyez honnÃªte.",
      "Quelle est la chose la plus osÃ©e que tu aies faite avec un(e) partenaire ?",
      "Qu'est-ce qui te met le plus dans l'ambiance rapidement ?",
      "As-tu dÃ©jÃ  envoyÃ© des photos compromettantes ? Ã‡a s'est bien passÃ© ?",
      "Quel est ton plus grand tabou que tu n'as jamais brisÃ© ?",
      "As-tu dÃ©jÃ  simulÃ© pour ne pas blesser quelqu'un ?",
      "Quelle est la chose la plus importante pour toi dans une relation physique ?",
      "As-tu dÃ©jÃ  eu une aventure d'un soir ? Ã‡a valait le coup ?",
      "Quel est le compliment le plus chaud qu'on t'ait jamais fait ?",
      "Quelle est ta vision de la nuit parfaite, avec tous les dÃ©tails ?",
      "As-tu dÃ©jÃ  utilisÃ© une app de rencontres ? Raconte l'expÃ©rience.",
      "Quelle est la chose qui t'attire instantanÃ©ment chez quelqu'un, physiquement ?",
      "Quel est le moment le plus gÃªnant que tu aies vÃ©cu dans un contexte intime ?",
      "As-tu dÃ©jÃ  eu des sentiments pour quelqu'un pendant une relation exclusive ?",
      "Quelle est ton opinion sur les relations ouvertes ?",
      "Qu'est-ce que tu adores faire mais n'avoues presque jamais ?",
      "Quelle est la chose la plus courageux que tu aies faite pour sÃ©duire quelqu'un ?",
      "DÃ©cris en 3 mots l'expÃ©rience intime idÃ©ale.",
    ],
  }
};

// Build pool
function buildPool(cats) {
  const pool = [];
  cats.forEach(cat => {
    Q[cat]?.action?.forEach((t, i) => pool.push({ id:`${cat}_a_${i}`, cat, type:'action', text:t }));
    Q[cat]?.verite?.forEach((t, i) => pool.push({ id:`${cat}_v_${i}`, cat, type:'verite', text:t }));
  });
  return shuffle(pool);
}

function shuffle(a) {
  const b = [...a];
  for (let i = b.length-1; i > 0; i--) {
    const j = Math.floor(Math.random()*(i+1));
    [b[i],b[j]] = [b[j],b[i]];
  }
  return b;
}

// =====================================================
// ğŸŒ STATE
// =====================================================
const COLORS = ['#ff2d78','#8b5cf6','#06d6e0','#fbbf24','#10b981','#f97316','#f472b6','#60a5fa','#a78bfa','#34d399','#fb7185','#38bdf8'];
const AVATARS = ['ğŸ˜','ğŸ¤©','ğŸ¥³','ğŸ˜ˆ','ğŸ¦Š','ğŸ±','ğŸ¦','ğŸ‰','ğŸ‘¾','ğŸ¤–','ğŸ­','ğŸŒŸ'];

let myId   = sessionStorage.getItem('aov2_uid') || Math.random().toString(36).slice(2,11);
sessionStorage.setItem('aov2_uid', myId);
let myName = '';
let myColor = '';
let myAvatar = '';
let roomCode = '';
let roomRef  = null;
let gameListener = null;
let selectedCats = ['classique','coquin'];

// =====================================================
// ğŸ–¥ï¸ SCREEN MANAGEMENT
// =====================================================
function showScreen(id) {
  document.querySelectorAll('.screen').forEach(s => s.classList.remove('show'));
  document.getElementById(id).classList.add('show');
  const backBtn = document.getElementById('back-btn');
  const showBack = ['screen-create','screen-join','screen-lobby','screen-game'].includes(id);
  backBtn.classList.toggle('vis', showBack);
}

function goBack() {
  leaveRoom();
  showScreen('screen-home');
}
function goHome() {
  leaveRoom();
  showScreen('screen-home');
}

function toggleCat(el) {
  const cat = el.dataset.cat;
  const ons = document.querySelectorAll('.cat-tile.on');
  if (el.classList.contains('on')) {
    if (ons.length <= 1) { toast('âš ï¸ Garde au moins une catÃ©gorie!', 'err'); return; }
    el.classList.remove('on');
    selectedCats = selectedCats.filter(c => c !== cat);
  } else {
    el.classList.add('on');
    selectedCats.push(cat);
  }
}

// =====================================================
// ğŸ—ï¸ CREATE GAME
// =====================================================
async function createGame() {
  const name = document.getElementById('c-name').value.trim();
  if (!name) { toast('Entre ton prÃ©nom !', 'err'); shakeEl('c-name'); return; }
  if (selectedCats.length === 0) { toast('Choisis au moins une catÃ©gorie!', 'err'); return; }

  const rounds = parseInt(document.getElementById('c-rounds').value);
  const code = genCode();
  const idx = Math.floor(Math.random() * COLORS.length);

  myName   = name;
  myColor  = COLORS[idx];
  myAvatar = AVATARS[idx];
  roomCode = code;

  const pool = buildPool(selectedCats);

  const gameData = {
    code,
    hostId: myId,
    status: 'lobby',
    categories: selectedCats,
    totalRounds: rounds,
    currentRound: 0,
    turnPlayerId: null,
    chosenType: null,
    currentQuestion: null,
    answers: {},
    usedIds: [],
    questionPool: pool.slice(0, 200),
    players: {
      [myId]: { id:myId, name, color:myColor, avatar:myAvatar, joinedAt: Date.now() }
    },
    createdAt: Date.now(),
    updatedAt: Date.now()
  };

  try {
    await db.ref(`games/${code}`).set(gameData);
    attachListener(code);
    showScreen('screen-lobby');
    renderLobby(gameData);
    toast('Partie crÃ©Ã©e! ğŸ‰', 'ok');
  } catch(e) {
    console.error(e);
    toast('Erreur Firebase. VÃ©rifie les rÃ¨gles de sÃ©curitÃ©.', 'err');
  }
}

// =====================================================
// ğŸšª JOIN GAME
// =====================================================
async function joinGame() {
  const name = document.getElementById('j-name').value.trim();
  const code = document.getElementById('j-code').value.trim().toUpperCase();

  if (!name) { toast('Entre ton prÃ©nom !', 'err'); shakeEl('j-name'); return; }
  if (code.length !== 4) { toast('Code Ã  4 caractÃ¨res !', 'err'); shakeEl('j-code'); return; }

  try {
    const snap = await db.ref(`games/${code}`).get();
    if (!snap.exists()) { toast('âŒ Code invalide! VÃ©rifie le code.', 'err'); shakeEl('j-code'); return; }

    const game = snap.val();
    if (game.status !== 'lobby') { toast('âš ï¸ La partie a dÃ©jÃ  commencÃ©!', 'err'); return; }

    const playerCount = Object.keys(game.players || {}).length;
    if (playerCount >= 8) { toast('Partie pleine (max 8 joueurs)!', 'err'); return; }

    const idx = playerCount % COLORS.length;
    myName   = name;
    myColor  = COLORS[idx];
    myAvatar = AVATARS[idx];
    roomCode = code;

    await db.ref(`games/${code}/players/${myId}`).set({
      id: myId, name, color: myColor, avatar: myAvatar, joinedAt: Date.now()
    });
    await db.ref(`games/${code}/updatedAt`).set(Date.now());

    attachListener(code);
    showScreen('screen-lobby');
    toast(`Bienvenue ${name}! ğŸŠ`, 'ok');
  } catch(e) {
    console.error(e);
    toast('Erreur de connexion.', 'err');
  }
}

// =====================================================
// ğŸ“¡ FIREBASE LISTENER
// =====================================================
function attachListener(code) {
  if (gameListener) gameListener();
  roomRef = db.ref(`games/${code}`);
  roomRef.on('value', snap => {
    if (!snap.exists()) return;
    const game = snap.val();
    const curScreen = document.querySelector('.screen.show')?.id;

    if (game.status === 'lobby') {
      renderLobby(game);
    } else if (['choosing','answering','reveal'].includes(game.status)) {
      if (curScreen === 'screen-lobby') showScreen('screen-game');
      renderGame(game);
    } else if (game.status === 'end') {
      renderEnd(game);
    }
  });
  gameListener = () => roomRef.off('value');
}

function leaveRoom() {
  if (gameListener) { gameListener(); gameListener = null; }
  roomRef = null;
  roomCode = '';
}

// =====================================================
// ğŸª LOBBY RENDER
// =====================================================
function renderLobby(game) {
  const el = id => document.getElementById(id);
  el('l-code').textContent = game.code;

  const players = Object.values(game.players || {}).sort((a,b) => a.joinedAt - b.joinedAt);
  const listEl = el('l-players');
  listEl.innerHTML = '';

  players.forEach(p => {
    const isHost = p.id === game.hostId;
    const isMe   = p.id === myId;
    const div = document.createElement('div');
    div.className = `player-row${isMe ? ' is-me' : ''}`;
    div.innerHTML = `
      <div class="p-avatar" style="background:${p.color}22;color:${p.color}">${p.avatar}</div>
      <div class="p-name">${p.name}</div>
      ${isHost ? '<span class="p-badge badge-host">ğŸ‘‘ HÃ´te</span>' : ''}
      ${isMe ? '<span class="p-badge badge-me">Moi</span>' : (!isHost ? '<span class="p-badge badge-ready">âœ“</span>' : '')}
    `;
    listEl.appendChild(div);
  });

  if (players.length < 8) {
    const empty = document.createElement('div');
    empty.className = 'slot-empty';
    empty.innerHTML = `<span style="font-size:18px">â•</span> En attente de joueurs...`;
    listEl.appendChild(empty);
  }

  // Settings
  const catNames = { classique:'ğŸ˜‚ Classique', coquin:'ğŸ˜ Coquin', couple:'ğŸ’‘ Couple', hot:'ğŸ”¥ Hot' };
  el('l-settings').innerHTML = `
    <strong>${game.totalRounds} rounds</strong> &nbsp;â€¢&nbsp; 
    ${(game.categories||[]).map(c => catNames[c] || c).join(' &nbsp;â€¢&nbsp; ')}
  `;

  // Status
  const cnt = players.length;
  el('l-status').textContent = cnt < 2 ? `${cnt}/2 joueurs minimum` : `${cnt} joueur${cnt>1?'s':''} connectÃ©${cnt>1?'s':''}`;

  // Start button
  const isHost = game.hostId === myId;
  const canStart = cnt >= 2;
  el('l-start').style.display = (isHost && canStart) ? 'flex' : 'none';
  el('l-hint').style.display = !isHost ? 'block' : 'none';
  el('l-hint').textContent = canStart ? "L'hÃ´te va lancer la partie..." : "En attente d'un autre joueur...";
  if (isHost && !canStart) {
    el('l-hint').style.display = 'block';
    el('l-hint').textContent = "Il faut au moins 2 joueurs pour commencer!";
  }
}

// =====================================================
// ğŸš€ START GAME
// =====================================================
async function startGame() {
  const snap = await db.ref(`games/${roomCode}`).get();
  const game = snap.val();
  if (!game) return;

  const playerIds = Object.keys(game.players).sort((a,b) => game.players[a].joinedAt - game.players[b].joinedAt);
  if (playerIds.length < 2) { toast('Il faut au moins 2 joueurs!', 'err'); return; }

  await db.ref(`games/${roomCode}`).update({
    status: 'choosing',
    currentRound: 1,
    turnPlayerId: playerIds[0],
    chosenType: null,
    currentQuestion: null,
    answers: {},
    updatedAt: Date.now()
  });
}

// =====================================================
// ğŸ® GAME RENDER
// =====================================================
function renderGame(game) {
  const isMyTurn   = game.turnPlayerId === myId;
  const turnPlayer = game.players?.[game.turnPlayerId];
  const isHost     = game.hostId === myId;

  // Header
  document.getElementById('g-turn-name').textContent = isMyTurn ? 'TON TOUR!' : (turnPlayer?.name || '?');
  document.getElementById('g-round').textContent = `Round ${game.currentRound}/${game.totalRounds}`;

  // Progress
  const pct = ((game.currentRound - 1) / game.totalRounds) * 100;
  document.getElementById('g-progress').style.width = pct + '%';

  // Phases
  const phases = ['phase-choose', 'phase-answer', 'phase-reveal'];
  phases.forEach(p => document.getElementById(p).style.display = 'none');

  if (game.status === 'choosing') {
    document.getElementById('phase-choose').style.display = 'block';
    const chooseBtns = document.getElementById('choose-btns');
    const chooseWait = document.getElementById('choose-waiting');
    const whoText = document.getElementById('choose-who-text');

    if (isMyTurn) {
      whoText.textContent = "C'EST TON TOUR!";
      chooseBtns.style.display = 'grid';
      chooseWait.style.display = 'none';
    } else {
      whoText.textContent = `${turnPlayer?.name || '?'} CHOISIT...`;
      chooseBtns.style.display = 'none';
      chooseWait.style.display = 'block';
    }

  } else if (game.status === 'answering') {
    document.getElementById('phase-answer').style.display = 'block';
    const q = game.currentQuestion;
    if (!q) return;

    document.getElementById('a-cat').textContent = q.cat;
    const tag = document.getElementById('a-type-tag');
    const card = document.getElementById('phase-answer');
    card.className = `q-card type-${q.type}${q.cat === 'hot' ? ' cat-hot' : ''}`;

    if (q.type === 'action') {
      tag.className = 'q-tag tag-action';
      tag.innerHTML = 'ğŸ’ª ACTION';
    } else {
      tag.className = 'q-tag tag-verite';
      tag.innerHTML = 'ğŸ’¬ VÃ‰RITÃ‰';
    }
    document.getElementById('a-question').textContent = q.text;

    const myTurnDiv    = document.getElementById('a-my-turn');
    const waitOthersDiv = document.getElementById('a-wait-others');
    const waitText     = document.getElementById('a-wait-text');

    const myAnswered = !!(game.answers && game.answers[myId]);
    const allPlayers = Object.keys(game.players || {});
    const allAnswered = allPlayers.every(pid => game.answers?.[pid]);

    if (myAnswered) {
      myTurnDiv.style.display = 'none';
      waitOthersDiv.style.display = 'block';
      const waiting = allPlayers.filter(pid => !game.answers?.[pid]).map(pid => game.players[pid]?.name).filter(Boolean);
      waitText.textContent = waiting.length ? `En attente de: ${waiting.join(', ')}` : 'Tous ont rÃ©pondu!';
    } else {
      myTurnDiv.style.display = 'block';
      waitOthersDiv.style.display = 'none';
      document.getElementById('a-input').value = '';
    }

  } else if (game.status === 'reveal') {
    document.getElementById('phase-answer').style.display = 'block';
    document.getElementById('phase-reveal').style.display = 'block';

    // Show question still
    const q = game.currentQuestion;
    if (q) {
      document.getElementById('a-cat').textContent = q.cat;
      const tag = document.getElementById('a-type-tag');
      if (q.type === 'action') {
        tag.className = 'q-tag tag-action';
        tag.innerHTML = 'ğŸ’ª ACTION';
      } else {
        tag.className = 'q-tag tag-verite';
        tag.innerHTML = 'ğŸ’¬ VÃ‰RITÃ‰';
      }
      document.getElementById('a-question').textContent = q.text;
      document.getElementById('r-question-recap').textContent = `"${q.text}"`;
    }
    document.getElementById('a-my-turn').style.display = 'none';
    document.getElementById('a-wait-others').style.display = 'none';

    // Render answers
    const answersEl = document.getElementById('r-answers');
    answersEl.innerHTML = '';
    Object.entries(game.answers || {}).forEach(([pid, ans]) => {
      const p = game.players?.[pid];
      if (!p) return;
      const div = document.createElement('div');
      div.className = 'answer-card';
      div.style.borderLeftColor = p.color;
      div.innerHTML = `
        <div class="answer-who" style="color:${p.color}">
          ${p.avatar} ${p.name}${pid === myId ? ' <span style="color:var(--muted);font-weight:400;font-size:11px">(moi)</span>' : ''}
        </div>
        <div class="${ans ? 'answer-text' : 'answer-empty'}">${ans || 'Pas de rÃ©ponse'}</div>
      `;
      answersEl.appendChild(div);
    });

    // Next button
    document.getElementById('r-next').style.display = isHost ? 'flex' : 'none';
    document.getElementById('r-wait-next').style.display = isHost ? 'none' : 'block';
  }
}

// =====================================================
// ğŸ¯ PLAYER ACTIONS
// =====================================================
async function pickType(type) {
  const snap = await db.ref(`games/${roomCode}`).get();
  const game = snap.val();
  if (!game || game.turnPlayerId !== myId) return;

  const usedIds = game.usedIds || [];
  const pool    = game.questionPool || [];
  const avail   = pool.filter(q => q.type === type && !usedIds.includes(q.id));
  const candidates = avail.length > 0 ? avail : pool.filter(q => q.type === type);

  if (candidates.length === 0) { toast('Plus de questions pour ce type!', 'err'); return; }

  const q = candidates[Math.floor(Math.random() * candidates.length)];
  const newUsed = [...usedIds, q.id].slice(-150);

  await db.ref(`games/${roomCode}`).update({
    status: 'answering',
    chosenType: type,
    currentQuestion: q,
    answers: {},
    usedIds: newUsed,
    updatedAt: Date.now()
  });
}

async function submitAnswer() {
  const answer = document.getElementById('a-input').value.trim();
  if (!answer) { toast('Ã‰cris une rÃ©ponse!', 'err'); shakeEl('a-input'); return; }

  const snap = await db.ref(`games/${roomCode}`).get();
  const game = snap.val();
  if (!game) return;

  const answers = { ...(game.answers || {}), [myId]: answer };
  const allPlayers = Object.keys(game.players || {});
  const allDone = allPlayers.every(pid => answers[pid]);

  await db.ref(`games/${roomCode}/answers/${myId}`).set(answer);
  await db.ref(`games/${roomCode}/updatedAt`).set(Date.now());

  if (allDone) {
    await db.ref(`games/${roomCode}/status`).set('reveal');
    await db.ref(`games/${roomCode}/updatedAt`).set(Date.now());
  }
}

async function nextRound() {
  const snap = await db.ref(`games/${roomCode}`).get();
  const game = snap.val();
  if (!game || game.hostId !== myId) return;

  if (game.currentRound >= game.totalRounds) {
    await db.ref(`games/${roomCode}`).update({ status: 'end', updatedAt: Date.now() });
    return;
  }

  const playerIds = Object.keys(game.players).sort((a,b) => game.players[a].joinedAt - game.players[b].joinedAt);
  const curIdx = playerIds.indexOf(game.turnPlayerId);
  const nextId = playerIds[(curIdx + 1) % playerIds.length];

  await db.ref(`games/${roomCode}`).update({
    status: 'choosing',
    currentRound: game.currentRound + 1,
    turnPlayerId: nextId,
    chosenType: null,
    currentQuestion: null,
    answers: {},
    updatedAt: Date.now()
  });
}

// =====================================================
// ğŸ† END
// =====================================================
function renderEnd(game) {
  showScreen('screen-end');
  spawnConfetti();

  const players = Object.values(game.players || {}).sort((a,b) => (b.score||0) - (a.score||0));
  document.getElementById('e-subtitle').textContent = `${game.totalRounds} rounds terminÃ©s â€” Bravo Ã  tous! ğŸ‰`;

  const medals = ['ğŸ¥‡','ğŸ¥ˆ','ğŸ¥‰'];
  const podium = document.getElementById('e-podium');
  podium.innerHTML = '';
  players.forEach((p, i) => {
    const div = document.createElement('div');
    div.className = 'podium-row';
    div.innerHTML = `
      <div class="podium-rank">${medals[i] || `${i+1}`}</div>
      <div class="p-avatar" style="background:${p.color}22;color:${p.color}">${p.avatar}</div>
      <div class="podium-name">${p.name}${p.id===myId?' (moi)':''}</div>
      <div class="podium-info">${game.totalRounds} rounds</div>
    `;
    podium.appendChild(div);
  });
}

function playAgain() {
  leaveRoom();
  showScreen('screen-home');
}

// =====================================================
// ğŸ¨ HELPERS
// =====================================================
function genCode() {
  const c = 'ABCDEFGHJKLMNPQRSTUVWXYZ23456789';
  return Array.from({length:4}, () => c[Math.floor(Math.random()*c.length)]).join('');
}

function copyCode() {
  navigator.clipboard.writeText(roomCode).then(() => toast('ğŸ“‹ Code copiÃ©!', 'ok')).catch(() => toast('Code: ' + roomCode, 'inf'));
}

let toastTimer;
function toast(msg, type='inf', dur=2800) {
  const t = document.getElementById('toast');
  t.textContent = msg;
  t.className = `${type} up`;
  clearTimeout(toastTimer);
  toastTimer = setTimeout(() => t.classList.remove('up'), dur);
}

function shakeEl(id) {
  const el = document.getElementById(id);
  if (!el) return;
  el.classList.add('shake');
  setTimeout(() => el.classList.remove('shake'), 400);
}

function spawnConfetti() {
  const cols = ['#ff2d78','#8b5cf6','#06d6e0','#fbbf24','#10b981','#f97316'];
  for (let i = 0; i < 70; i++) {
    const el = document.createElement('div');
    el.className = 'confetti-piece';
    const size = 6 + Math.random() * 10;
    el.style.cssText = `
      position:fixed;left:${Math.random()*100}vw;top:-20px;width:${size}px;height:${size}px;
      background:${cols[Math.floor(Math.random()*cols.length)]};
      border-radius:${Math.random()>.5?'50%':'2px'};
      animation:confetti ${2+Math.random()*3}s ${Math.random()*1.5}s linear forwards;
      z-index:9999;pointer-events:none;
    `;
    document.body.appendChild(el);
    setTimeout(() => el.remove(), 5000);
  }
}

// =====================================================
// ğŸ¨ ANIMATED BACKGROUND
// =====================================================
(function initBg() {
  const canvas = document.getElementById('bg-canvas');
  const ctx = canvas.getContext('2d');
  let W, H, orbs;

  function resize() {
    W = canvas.width  = window.innerWidth;
    H = canvas.height = window.innerHeight;
  }

  function mkOrb() {
    return {
      x: Math.random() * W, y: Math.random() * H,
      r: 200 + Math.random() * 300,
      vx: (Math.random()-.5)*.3, vy: (Math.random()-.5)*.3,
      color: ['#ff2d7820','#8b5cf620','#06d6e015'][Math.floor(Math.random()*3)]
    };
  }

  resize();
  window.addEventListener('resize', resize);
  orbs = Array.from({length:4}, mkOrb);

  function draw() {
    ctx.clearRect(0,0,W,H);
    orbs.forEach(o => {
      const g = ctx.createRadialGradient(o.x,o.y,0,o.x,o.y,o.r);
      g.addColorStop(0, o.color);
      g.addColorStop(1, 'transparent');
      ctx.fillStyle = g;
      ctx.beginPath();
      ctx.arc(o.x,o.y,o.r,0,Math.PI*2);
      ctx.fill();
      o.x += o.vx; o.y += o.vy;
      if (o.x < -o.r || o.x > W+o.r) o.vx *= -1;
      if (o.y < -o.r || o.y > H+o.r) o.vy *= -1;
    });
    requestAnimationFrame(draw);
  }
  draw();
})();

// =====================================================
// ğŸ”¥ INIT â€” Test Firebase connection
// =====================================================
window.addEventListener('load', async () => {
  try {
    // Try a quick read to verify Firebase is reachable
    await db.ref('.info/connected').get();
    toast('âœ… ConnectÃ©!', 'ok', 2000);
  } catch(e) {
    console.warn('Firebase init warning:', e);
    toast('âš ï¸ VÃ©rifie ta connexion', 'err');
  }
  // Small delay for visual polish
  setTimeout(() => showScreen('screen-home'), 800);
});
</script>

</body>
</html>